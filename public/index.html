<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Discord Lookup</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Dark Mode Setup -->
    <script>
      // Check saved theme preference or system setting
      if (
        localStorage.getItem("theme") === "dark" ||
        (!("theme" in localStorage) &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
      function toggleDarkMode() {
        document.documentElement.classList.toggle("dark");
        if (document.documentElement.classList.contains("dark")) {
          localStorage.setItem("theme", "dark");
        } else {
          localStorage.setItem("theme", "light");
        }
      }
    </script>
    <style>
      /* Smooth transitions for background and text colors */
      body {
        transition: background-color 0.3s, color 0.3s;
      }
    </style>
  </head>
  <!-- Light mode: white background, black text; Dark mode: black background, white text -->
  <body class="min-h-screen bg-white text-black dark:bg-black dark:text-white">
    <!-- HEADER -->
    <header class="py-6 text-center border-b border-gray-300 dark:border-gray-700">
      <h1 class="text-4xl font-bold">Discord Lookup</h1>
      <button
        onclick="toggleDarkMode()"
        class="mt-4 px-4 py-2 border border-gray-600 dark:border-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-800 transition"
      >
        Toggle Dark/Light Mode
      </button>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex flex-col items-center justify-center py-10">
      <div class="w-full max-w-lg p-6 bg-gray-100 dark:bg-gray-900 rounded shadow-md">
        <form id="lookupForm" class="space-y-4">
          <div>
            <label for="userId" class="block text-lg font-medium">
              Enter Discord User ID:
            </label>
            <input
              type="text"
              id="userId"
              name="userId"
              placeholder="e.g. 1060558266872123454"
              class="w-full mt-2 p-2 border border-gray-400 rounded bg-white dark:bg-gray-800 text-black dark:text-white"
            />
          </div>
          <button
            type="submit"
            class="w-full py-2 bg-gray-800 dark:bg-gray-200 text-white dark:text-black font-bold rounded hover:opacity-90 transition"
          >
            Lookup User
          </button>
        </form>
        <div id="lookupResult" class="mt-6"></div>
      </div>
    </main>

    <!-- FOOTER -->
    <footer class="py-4 text-center border-t border-gray-300 dark:border-gray-700">
      &copy; 2025 Discord Lookup. All rights reserved.
    </footer>

    <!-- JAVASCRIPT -->
    <script>
      // Helper: Convert Discord snowflake to UTC date string.
      function getCreationDateFromSnowflake(snowflake) {
        const discordEpoch = 1420070400000;
        const snowflakeBigInt = BigInt(snowflake);
        const timestamp =
          Number((snowflakeBigInt >> 22n) + BigInt(discordEpoch));
        return new Date(timestamp).toUTCString();
      }

      const lookupForm = document.getElementById("lookupForm");
      const lookupResult = document.getElementById("lookupResult");

      lookupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const userId = document.getElementById("userId").value.trim();
        if (!userId) {
          alert("Please enter a Discord User ID.");
          return;
        }
        lookupResult.innerHTML =
          '<p class="text-center">Looking up...</p>';
        try {
          // Call the serverless function at /api/lookup
          const response = await fetch(`/api/lookup?userId=${userId}`);
          if (!response.ok) {
            const errorData = await response.json();
            lookupResult.innerHTML = `<p class="text-center text-red-500">Error: ${errorData.error}</p>`;
            return;
          }
          const data = await response.json();
          const createdAt = getCreationDateFromSnowflake(data.id);
          // Build avatar URL if the user has one.
          const avatarUrl = data.avatar
            ? `https://cdn.discordapp.com/avatars/${data.id}/${data.avatar}${
                data.avatar.startsWith("a_") ? ".gif" : ".png"
              }`
            : null;
          // Use accent_color if available.
          const bannerColor = data.accent_color
            ? `#${data.accent_color.toString(16).padStart(6, "0").toUpperCase()}`
            : "None";

          lookupResult.innerHTML = `
            <div class="p-4">
              <p><strong>User ID:</strong> ${data.id}</p>
              <p><strong>Username:</strong> ${data.username}#${data.discriminator}</p>
              ${
                avatarUrl
                  ? `<p><strong>Avatar:</strong> <img src="${avatarUrl}" alt="Avatar" class="w-16 h-16 rounded-full inline-block"></p>`
                  : ""
              }
              <p><strong>Created:</strong> ${createdAt}</p>
              <p><strong>Banner Color:</strong> ${
                bannerColor !== "None"
                  ? `<span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: ${bannerColor};"></span>${bannerColor}`
                  : "None"
              }</p>
            </div>
          `;
        } catch (error) {
          console.error(error);
          lookupResult.innerHTML = `<p class="text-center text-red-500">An error occurred while looking up the user.</p>`;
        }
      });
    </script>
  </body>
</html>
